#!/bin/sh

AIRPODS_MAC="2C:18:09:E3:03:33"

ID="$(echo $AIRPODS_MAC | sed -e 's/:/_/g')"

print_usage() {
  echo "Usage: airpods <info|off|re|restart>"
}

get_airpods_sink_id() {
  wpctl status | sed -n '/├─ Sinks:/,/├─ Sources:/p' | grep -E "AirPods|$ID" | grep -v "Audio/Sink" | sed -E 's/^[^0-9]*([0-9]+)\..*/\1/' | head -n1
}

if [ -z "$1" ]; then
  print_usage
  exit 1
fi

connected="$(bluetoothctl info ${AIRPODS_MAC} | grep 'Connected: yes')"

if [ "$1" = "info" ]; then
  active_sink="$(wpctl status | grep -A 20 'Sinks:' | grep '\*')"

  if echo "$active_sink" | grep -qE "AirPods|bluez|$ID"; then
    echo "on"
  else
    echo "off"
  fi
  exit 0
fi

case "$1" in
  "off")
    if [ -n "$connected" ]; then
      bluetoothctl disconnect "$AIRPODS_MAC"
      echo "AirPods Pro disconnected"
    else
      echo "AirPods Pro not connected"
    fi
    ;;

  "re" | "restart")
    if [ -z "$connected" ]; then
      echo "AirPods Pro not connected, connecting..."
      bluetoothctl connect "$AIRPODS_MAC"
      sleep 2
    else
      bluetoothctl disconnect "$AIRPODS_MAC"
      sleep 1
      bluetoothctl connect "$AIRPODS_MAC"
      sleep 2
    fi

    airpods_sink_id="$(get_airpods_sink_id)"
    if [ -z "$airpods_sink_id" ]; then
      sleep 1
      airpods_sink_id="$(get_airpods_sink_id)"
    fi

    if [ -n "$airpods_sink_id" ]; then
      wpctl set-default "$airpods_sink_id"
      echo "AirPods Pro connected and set as default"
    else
      echo "AirPods Pro connected"
    fi
    exit 0
    ;;

  *)
    print_usage
    exit 1
    ;;
esac

exit 0
